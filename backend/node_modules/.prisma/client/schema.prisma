generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------
// Player
// -----------------
model Player {
  id               String               @id @default(cuid())
  username         String               @unique
  avatar           String
  grade            Int
  className        String
  currentMask      Mask?                @relation("CurrentMask", fields: [currentMaskId], references: [id])
  currentMaskId    String?
  masksOwned       PlayerMask[]
  energy           Int                  @default(100)
  mood             String               @default("neutral")
  time             String               @default("08:00")
  reputation       Int                  @default(0)
  relationships    PlayerRelationship[]
  inventory        PlayerItem[]
  minigameProgress PlayerMinigame[]
  eventsCompleted  PlayerEvent[]
  location         Zone?                @relation(fields: [zoneId], references: [id])
  zoneId           String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
}

// -----------------
// Masks
// -----------------
model Mask {
  id                 String       @id
  name               String
  alias              String
  description        String
  personality        String
  corruption         Int          @default(0)
  abilities          Json // { hint, dangerSense, illusion, empathy }
  dailyEffects       Json // { dialogueColor, overlay, bonusStats }
  corruptionTriggers String[]
  unlockRequirements String[]
  image              String
  symbol             String
  players            PlayerMask[]
  currentPlayers     Player[]     @relation("CurrentMask")
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model PlayerMask {
  id         String @id @default(cuid())
  player     Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId   String
  mask       Mask   @relation(fields: [maskId], references: [id])
  maskId     String
  corruption Int    @default(0)

  @@unique([playerId, maskId])
}

// -----------------
// NPCs (Students & Teachers)
// -----------------
model NPC {
  id                  String               @id
  name                String
  role                String // Student | Teacher | Director
  traits              String[]
  personality         String
  schedule            Json // [{ time, zoneId }]
  relationship        Int                  @default(0)
  rumorScore          Int                  @default(0)
  reactions           Json // { mask_id: reaction_text }
  events              String[] // event ids
  portrait            String
  location            Zone?                @relation(fields: [zoneId], references: [id])
  zoneId              String?
  playerRelationships PlayerRelationship[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

// -----------------
// Zones / Locations
// -----------------
model Zone {
  id          String   @id
  name        String
  type        String // class | hallway | special
  description String?
  npcs        NPC[]
  players     Player[]
  events      Event[]
  actions     Action[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// -----------------
// Items
// -----------------
model Item {
  id          String       @id
  name        String
  type        String // consumable | equipment | quest
  description String
  effects     Json // { energy, mood, relationship }
  image       String
  players     PlayerItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model PlayerItem {
  id       String @id @default(cuid())
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId String
  item     Item   @relation(fields: [itemId], references: [id])
  itemId   String
  quantity Int    @default(1)

  @@unique([playerId, itemId])
}

// -----------------
// Minigames
// -----------------
model Minigame {
  id             String           @id
  classId        String
  name           String
  description    String
  difficulty     Int
  maskModifiers  Json // { mask_id: { bonus } }
  rewards        Json // { grade, insight, charm, chaos }
  playerProgress PlayerMinigame[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model PlayerMinigame {
  id         String   @id @default(cuid())
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId   String
  minigame   Minigame @relation(fields: [minigameId], references: [id])
  minigameId String
  score      Int      @default(0)
  completed  Boolean  @default(false)

  @@unique([playerId, minigameId])
}

// -----------------
// Events
// -----------------
model Event {
  id            String        @id
  name          String
  triggerChance Int
  triggerZones  String[]
  maskModifiers Json // { mask: { bonus } }
  choices       Json // [{ id, text, effect }]
  zone          Zone?         @relation(fields: [zoneId], references: [id])
  zoneId        String?
  players       PlayerEvent[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model PlayerEvent {
  id         String  @id @default(cuid())
  player     Player  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId   String
  event      Event   @relation(fields: [eventId], references: [id])
  eventId    String
  choiceMade String?
  completed  Boolean @default(false)

  @@unique([playerId, eventId])
}

// -----------------
// Actions
// -----------------
model Action {
  id            String   @id
  name          String
  zone          Zone?    @relation(fields: [zoneId], references: [id])
  zoneId        String?
  preconditions Json // { currentMask, inventory, etc. }
  timeCost      Int
  effects       Json // { reputation, grade, maskCorruption, relationships }
  riskLevel     String // low | medium | high
  maskModifiers Json // { mask: { bonus } }
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// -----------------
// Relationships with NPCs
// -----------------
model PlayerRelationship {
  id       String @id @default(cuid())
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId String
  npc      NPC    @relation(fields: [npcId], references: [id])
  npcId    String
  affinity Int    @default(0) // -100 to 100

  @@unique([playerId, npcId])
}
