generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // or "mysql" / "sqlite"
  url      = env("DATABASE_URL")
}

// -----------------
// Player
// -----------------
model Player {
  id               String             @id @default(cuid())
  username         String
  avatar           String
  grade            Int
  className        String
  currentMask      Mask?              @relation(fields: [currentMaskId], references: [id])
  currentMaskId    String?
  masksOwned       PlayerMask[]
  energy           Int                @default(100)
  mood             String             @default("neutral")
  time             String             @default("08:00")
  reputation       Int                @default(0)
  relationships    PlayerRelationship[]
  inventory        PlayerItem[]
  minigameProgress PlayerMinigame[]
  eventsCompleted  PlayerEvent[]
  location         Zone?              @relation(fields: [zoneId], references: [id])
  zoneId           String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

// -----------------
// Masks
// -----------------
model Mask {
  id        String        @id @default(cuid())
  name      String
  personality String
  description String
  rarity    String
  image     String
  effects   Json          // e.g., { npcRelationshipModifier, minigameBonus }
  players   PlayerMask[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model PlayerMask {
  id       String  @id @default(cuid())
  player   Player  @relation(fields: [playerId], references: [id])
  playerId String
  mask     Mask    @relation(fields: [maskId], references: [id])
  maskId   String
}

// -----------------
// NPCs
// -----------------
model NPC {
  id                  String       @id @default(cuid())
  name                String
  role                String       // student | teacher | director
  traits              String[]     // array of strings
  personality         String
  schedule            Json         // array of {time, zoneId}
  relationshipDefault Int
  rumorScore          Int
  reactions           Json         // {mask_id: reaction_text}
  portrait            String
  events              Event[]      @relation("NPCEvents")
  location            Zone?        @relation(fields: [zoneId], references: [id])
  zoneId              String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

// -----------------
// Zones / Locations
// -----------------
model Zone {
  id          String    @id @default(cuid())
  name        String    // e.g., "Classroom A", "Library", "Gym"
  type        String    // class | hallway | courtyard | special
  description String?
  npcs        NPC[]
  players     Player[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// -----------------
// Items
// -----------------
model Item {
  id          String        @id @default(cuid())
  name        String
  type        String        // consumable | equipment | quest
  description String
  effects     Json          // { energy, mood, relationship[npcId] }
  image       String
  players     PlayerItem[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model PlayerItem {
  id       String  @id @default(cuid())
  player   Player  @relation(fields: [playerId], references: [id])
  playerId String
  item     Item    @relation(fields: [itemId], references: [id])
  itemId   String
  quantity Int     @default(1)
}

// -----------------
// Minigames
// -----------------
model Minigame {
  id              String             @id @default(cuid())
  name            String
  classType       String             // e.g., "Math", "Science"
  difficulty      Int
  timeCost        Int                // minutes
  rewards         Json               // {points, items: [itemIds]}
  description     String
  image           String
  playerProgress  PlayerMinigame[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model PlayerMinigame {
  id          String    @id @default(cuid())
  player      Player    @relation(fields: [playerId], references: [id])
  playerId    String
  minigame    Minigame  @relation(fields: [minigameId], references: [id])
  minigameId  String
  score       Int       @default(0)
  completed   Boolean   @default(false)
}

// -----------------
// Events
// -----------------
model Event {
  id          String      @id @default(cuid())
  name        String
  description String
  trigger     Json        // {time, zoneId, npcId, playerMask}
  choices     Json        // array of choice objects with outcomes
  npcs        NPC[]       @relation("NPCEvents")
  players     PlayerEvent[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PlayerEvent {
  id        String  @id @default(cuid())
  player    Player  @relation(fields: [playerId], references: [id])
  playerId  String
  event     Event   @relation(fields: [eventId], references: [id])
  eventId   String
  completed Boolean @default(false)
}

// -----------------
// Relationships with NPCs
// -----------------
model PlayerRelationship {
  id        String  @id @default(cuid())
  player    Player  @relation(fields: [playerId], references: [id])
  playerId  String
  npc       NPC     @relation(fields: [npcId], references: [id])
  npcId     String
  affinity  Int     @default(0)   // -100 to 100
}
